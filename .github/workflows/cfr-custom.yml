name: Run CFR with custom LiPD data

on:
  workflow_run:
    workflows: ['docker-build']
    types: [completed]
  workflow_dispatch:
  push:
    paths:
      - 'cfr_main_code.py'
      - 'lmr_configs.yml'

env:
  IMAGE_NAME: davidedge/lmr2:latest

jobs:
  run-cfr-custom:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract LiPD data URL from config
      id: get_url
      run: |
        # Extract lipd_data_url from lmr_configs.yml
        LIPD_URL=$(python -c "
        import yaml
        with open('lmr_configs.yml', 'r') as f:
            config = yaml.safe_load(f)
        print(config.get('lipd_data_url', ''))
        ")

        if [ -z "$LIPD_URL" ]; then
          echo "ERROR: lipd_data_url not found in lmr_configs.yml"
          exit 1
        fi

        echo "lipd_url=$LIPD_URL" >> $GITHUB_OUTPUT
        echo "LiPD data URL: $LIPD_URL"

    - name: Download LiPD pickle file
      run: |
        echo "Downloading LiPD data from: ${{ steps.get_url.outputs.lipd_url }}"
        curl -L -o "${GITHUB_WORKSPACE}/lipd.pkl" "${{ steps.get_url.outputs.lipd_url }}"

        echo "Verifying downloaded file:"
        ls -lh "${GITHUB_WORKSPACE}/lipd.pkl"

        # Check file is not empty and is actually a pickle file
        if [ ! -s "${GITHUB_WORKSPACE}/lipd.pkl" ]; then
          echo "ERROR: Downloaded file is empty"
          exit 1
        fi

    - name: Install Python dependencies for conversion
      run: |
        python -m pip install --upgrade pip
        python -m pip install pandas numpy

    - name: Convert LiPD to CFR DataFrame format
      run: |
        echo "Converting LiPD pickle to CFR-compatible DataFrame pickle..."
        python convert_lipd_to_cfr_dataframe.py lipd.pkl lipd_cfr.pkl

        echo ""
        echo "Conversion complete! Verifying output:"
        ls -lh lipd_cfr.pkl

        # Verify the converted file can be loaded
        python -c "
        import pandas as pd
        df = pd.read_pickle('lipd_cfr.pkl')
        print(f'✓ DataFrame loaded successfully: {df.shape[0]} proxies')
        print(f'✓ Columns: {list(df.columns)}')
        print(f'✓ Proxy types: {df[\"ptype\"].value_counts().to_dict()}')
        "

    - name: Create swap space
      run: |
        sudo fallocate -l 5G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        sudo swapon --show
        free -h

    - name: Pull Docker image
      run: docker pull ${{ env.IMAGE_NAME }}

    - name: Create output directory
      run: mkdir -p ./recons

    - name: Run CFR analysis with custom data
      run: |
        echo "Running CFR analysis with converted LiPD data..."
        docker run --rm \
          -v "${{ github.workspace }}/lipd_cfr.pkl":/app/lipd_cfr.pkl:ro \
          -v "${{ github.workspace }}/cfr_main_code.py":/app/cfr_main_code.py:ro \
          -v "${{ github.workspace }}/lmr_configs.yml":/app/lmr_configs.yml:ro \
          -v "${{ github.workspace }}/recons":/app/recons \
          -w /app \
          ${{ env.IMAGE_NAME }} \
          conda run -n cfr-env python cfr_main_code.py

    - name: List output files
      run: |
        echo "Generated files:"
        ls -lh ./recons/

    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: cfr-custom-results-${{ github.run_number }}
        path: ./recons/
        retention-days: 30

    - name: Upload converted data as artifact (optional)
      uses: actions/upload-artifact@v4
      with:
        name: lipd-cfr-converted-${{ github.run_number }}
        path: ./lipd_cfr.pkl
        retention-days: 7

    - name: Commit results to repository (optional)
      if: github.event_name == 'push'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add recons/ || true
        git diff --staged --quiet || git commit -m "Add CFR custom data analysis results from run ${{ github.run_number }}"
        git push || echo "No changes to push"
