name: Visualize Latest CFR Results

on:
  workflow_dispatch:
  schedule:
    # Optional: Run daily at midnight UTC to visualize latest results
    - cron: '0 0 * * *'

jobs:
  find-latest-cfr-run:
    name: Find Latest CFR Run
    runs-on: ubuntu-latest
    outputs:
      run_number: ${{ steps.get_run.outputs.run_number }}
      run_id: ${{ steps.get_run.outputs.run_id }}
      artifact_name: ${{ steps.get_run.outputs.artifact_name }}

    steps:
      - name: Find latest successful CFR run
        id: get_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest successful run of "Run CFR Analysis" workflow
          latest_run=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/workflows/run-cfr.yml/runs?status=success&per_page=1" \
            --jq '.workflow_runs[0]')

          run_id=$(echo "$latest_run" | jq -r '.id')
          run_number=$(echo "$latest_run" | jq -r '.run_number')

          if [ "$run_id" = "null" ] || [ -z "$run_id" ]; then
            echo "Error: No successful CFR runs found"
            exit 1
          fi

          artifact_name="cfr-results-${run_number}"

          echo "Found latest successful CFR run:"
          echo "  Run ID: $run_id"
          echo "  Run Number: $run_number"
          echo "  Artifact: $artifact_name"

          echo "run_id=$run_id" >> $GITHUB_OUTPUT
          echo "run_number=$run_number" >> $GITHUB_OUTPUT
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT

  download-cfr-artifact:
    name: Download CFR Artifact
    needs: find-latest-cfr-run
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact from CFR run
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.find-latest-cfr-run.outputs.artifact_name }}
          path: ./cfr-data
          run-id: ${{ needs.find-latest-cfr-run.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Verify downloaded files
        run: |
          echo "Downloaded CFR artifacts:"
          ls -lh ./cfr-data/
          echo ""
          echo "Checking subdirectories:"
          find ./cfr-data -type f -name "*.nc" | head -20

      - name: Flatten directory structure
        run: |
          echo "Flattening directory structure for presto-viz..."
          # Find all .nc files and move them to cfr-data root
          find ./cfr-data -type f -name "*.nc" -exec mv {} ./cfr-data/ \;
          # Remove empty subdirectories
          find ./cfr-data -type d -empty -delete
          echo ""
          echo "Files after flattening:"
          ls -lh ./cfr-data/

      - name: Re-upload for presto-viz
        uses: actions/upload-artifact@v4
        with:
          name: cfr-data-for-viz-${{ github.run_number }}
          path: ./cfr-data/
          retention-days: 7

  visualize-and-deploy:
    name: Generate and Deploy Visualization
    needs: [find-latest-cfr-run, download-cfr-artifact]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Checkout LMR2 repository (target for deployment)
      - name: Checkout LMR2 repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # Checkout presto-viz as a tool
      - name: Checkout presto-viz
        uses: actions/checkout@v4
        with:
          repository: DaveEdge1/presto-viz
          path: presto-viz

      # Download the CFR data artifact
      - name: Download CFR data
        uses: actions/download-artifact@v4
        with:
          name: cfr-data-for-viz-${{ github.run_number }}
          path: ./data/CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}

      # Setup Python and dependencies
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install numpy xarray matplotlib cartopy regionmask bokeh netCDF4 pyyaml

      # Configure git for commits
      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      # Run presto-viz with automatic GitHub Pages deployment
      - name: Run presto-viz and deploy
        env:
          COMMIT_VIZ_OUTPUT: 'true'
          GIT_REPO_ROOT: ${{ github.workspace }}
          VIZ_OUTPUT_PATH: 'docs'
          VIZ_GIT_BRANCH: 'gh-pages'
          VIZ_COMMIT_MSG: "Deploy visualization from CFR run ${{ needs.find-latest-cfr-run.outputs.run_number }} (viz run ${{ github.run_number }})"
        run: |
          DATA_DIR="${{ github.workspace }}/data/CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}"
          OUTPUT_DIR="${{ github.workspace }}/output/CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}"
          WEB_ASSETS="${{ github.workspace }}/presto-viz/viz/web_assets/"

          echo "Data directory: $DATA_DIR"
          echo "Output directory: $OUTPUT_DIR"
          echo "Web assets: $WEB_ASSETS"

          # Create output directory
          mkdir -p "$OUTPUT_DIR"

          # Run scripts from workspace root (not from presto-viz directory)
          # This is important for multiprocessing to work correctly

          # Run script 1: Format data
          python presto-viz/1_format_data_daholocene_graphem.py "$DATA_DIR"

          # Run script 2: Make maps and time series
          python presto-viz/2_make_maps_and_ts.py "$DATA_DIR" "$OUTPUT_DIR"

          # Run script 3: Make HTML file (automatically commits to gh-pages)
          python presto-viz/3_make_html_file.py "$DATA_DIR" "$OUTPUT_DIR" "$WEB_ASSETS"

      # Upload output as artifact for reference
      - name: Upload visualization output
        uses: actions/upload-artifact@v4
        with:
          name: presto-viz-output-CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}
          path: output/
          retention-days: 30

