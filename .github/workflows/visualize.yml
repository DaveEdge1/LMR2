name: Visualize Latest CFR Results

on:
  workflow_dispatch:
  schedule:
    # Optional: Run daily at midnight UTC to visualize latest results
    - cron: '0 0 * * *'

jobs:
  find-latest-cfr-run:
    name: Find Latest CFR Run
    runs-on: ubuntu-latest
    outputs:
      run_number: ${{ steps.get_run.outputs.run_number }}
      run_id: ${{ steps.get_run.outputs.run_id }}
      artifact_name: ${{ steps.get_run.outputs.artifact_name }}

    steps:
      - name: Find latest successful CFR run
        id: get_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest successful run of "Run CFR Analysis" workflow
          latest_run=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/workflows/run-cfr.yml/runs?status=success&per_page=1" \
            --jq '.workflow_runs[0]')

          run_id=$(echo "$latest_run" | jq -r '.id')
          run_number=$(echo "$latest_run" | jq -r '.run_number')

          if [ "$run_id" = "null" ] || [ -z "$run_id" ]; then
            echo "Error: No successful CFR runs found"
            exit 1
          fi

          artifact_name="cfr-results-${run_number}"

          echo "Found latest successful CFR run:"
          echo "  Run ID: $run_id"
          echo "  Run Number: $run_number"
          echo "  Artifact: $artifact_name"

          echo "run_id=$run_id" >> $GITHUB_OUTPUT
          echo "run_number=$run_number" >> $GITHUB_OUTPUT
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT

  download-cfr-artifact:
    name: Download CFR Artifact
    needs: find-latest-cfr-run
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact from CFR run
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.find-latest-cfr-run.outputs.artifact_name }}
          path: ./cfr-data
          run-id: ${{ needs.find-latest-cfr-run.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Verify downloaded files
        run: |
          echo "Downloaded CFR artifacts:"
          ls -lh ./cfr-data/

      - name: Re-upload for presto-viz
        uses: actions/upload-artifact@v4
        with:
          name: cfr-data-for-viz-${{ github.run_number }}
          path: ./cfr-data/
          retention-days: 7

  visualize:
    name: Generate Presto Visualization
    needs: [find-latest-cfr-run, download-cfr-artifact]
    uses: DaveEdge1/presto-viz/.github/workflows/presto-viz-reusable.yml@main
    with:
      reconstruction_id: CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}
      artifact_name: cfr-data-for-viz-${{ github.run_number }}
