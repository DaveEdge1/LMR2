name: Visualize Latest CFR Results

on:
  workflow_dispatch:
  schedule:
    # Optional: Run daily at midnight UTC to visualize latest results
    - cron: '0 0 * * *'

jobs:
  find-latest-cfr-run:
    name: Find Latest CFR Run
    runs-on: ubuntu-latest
    outputs:
      run_number: ${{ steps.get_run.outputs.run_number }}
      run_id: ${{ steps.get_run.outputs.run_id }}
      artifact_name: ${{ steps.get_run.outputs.artifact_name }}

    steps:
      - name: Find latest successful CFR run
        id: get_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest successful run of "Run CFR Analysis" workflow
          latest_run=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/workflows/run-cfr.yml/runs?status=success&per_page=1" \
            --jq '.workflow_runs[0]')

          run_id=$(echo "$latest_run" | jq -r '.id')
          run_number=$(echo "$latest_run" | jq -r '.run_number')

          if [ "$run_id" = "null" ] || [ -z "$run_id" ]; then
            echo "Error: No successful CFR runs found"
            exit 1
          fi

          artifact_name="cfr-results-${run_number}"

          echo "Found latest successful CFR run:"
          echo "  Run ID: $run_id"
          echo "  Run Number: $run_number"
          echo "  Artifact: $artifact_name"

          echo "run_id=$run_id" >> $GITHUB_OUTPUT
          echo "run_number=$run_number" >> $GITHUB_OUTPUT
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT

  download-cfr-artifact:
    name: Download CFR Artifact
    needs: find-latest-cfr-run
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact from CFR run
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.find-latest-cfr-run.outputs.artifact_name }}
          path: ./cfr-data
          run-id: ${{ needs.find-latest-cfr-run.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Verify downloaded files
        run: |
          echo "Downloaded CFR artifacts:"
          ls -lh ./cfr-data/
          echo ""
          echo "Checking subdirectories:"
          find ./cfr-data -type f -name "*.nc" | head -20

      - name: Flatten directory structure
        run: |
          echo "Flattening directory structure for presto-viz..."
          # Find all .nc files and move them to cfr-data root
          find ./cfr-data -type f -name "*.nc" -exec mv {} ./cfr-data/ \;
          # Remove empty subdirectories
          find ./cfr-data -type d -empty -delete
          echo ""
          echo "Files after flattening:"
          ls -lh ./cfr-data/

      - name: Re-upload for presto-viz
        uses: actions/upload-artifact@v4
        with:
          name: cfr-data-for-viz-${{ github.run_number }}
          path: ./cfr-data/
          retention-days: 7

  visualize:
    name: Generate Presto Visualization
    needs: [find-latest-cfr-run, download-cfr-artifact]
    # TODO: Switch to fix branch after applying fix to presto-viz - see .github/PRESTO_VIZ_FIX.md
    # uses: DaveEdge1/presto-viz/.github/workflows/presto-viz-reusable.yml@fix/cfr-dimension-order
    uses: DaveEdge1/presto-viz/.github/workflows/presto-viz-reusable.yml@main
    with:
      reconstruction_id: CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}
      artifact_name: cfr-data-for-viz-${{ github.run_number }}

  deploy-to-pages:
    name: Deploy Visualization to GitHub Pages
    needs: [find-latest-cfr-run, visualize]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download visualization output
        uses: actions/download-artifact@v4
        with:
          name: presto-viz-output-CFR_Run_${{ needs.find-latest-cfr-run.outputs.run_number }}_Reviz_${{ github.run_number }}
          path: ./viz-output

      - name: Prepare docs directory
        run: |
          echo "Preparing docs directory for GitHub Pages..."
          mkdir -p docs

          # Copy visualization output to docs
          cp -r ./viz-output/* docs/

          # Create index redirect if main HTML exists
          if [ -f "docs/index.html" ]; then
            echo "Main index.html found"
          else
            echo "Creating index.html redirect to main visualization"
            # Find the main HTML file (usually has the reconstruction ID in name)
            MAIN_HTML=$(find docs -name "*.html" -type f | head -1)
            if [ -n "$MAIN_HTML" ]; then
              MAIN_HTML_NAME=$(basename "$MAIN_HTML")
              cat > docs/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0; url=./${MAIN_HTML_NAME}">
            <title>CFR Visualization</title>
          </head>
          <body>
            <p>Redirecting to <a href="./${MAIN_HTML_NAME}">visualization</a>...</p>
          </body>
          </html>
          EOF
            fi
          fi

          # List contents
          echo "Contents of docs directory:"
          ls -lah docs/

      - name: Create README for Pages
        run: |
          cat > docs/README.md << EOF
          # CFR Visualization Results

          **Latest Run:** CFR Run ${{ needs.find-latest-cfr-run.outputs.run_number }}
          **Visualization Run:** ${{ github.run_number }}
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          This directory contains the interactive visualization generated from the Latest Millennium Reanalysis (LMR) / Climate Field Reconstruction (CFR) results.

          Visit the [visualization page](https://DaveEdge1.github.io/LMR2/) to view the results.
          EOF

      - name: Commit and push to gh-pages
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Create or checkout gh-pages branch
          git fetch origin gh-pages || git checkout --orphan gh-pages || git checkout gh-pages

          # Remove old files
          git rm -rf . || true

          # Copy docs contents to root for gh-pages
          cp -r docs/* .

          # Add and commit
          git add .
          git commit -m "Deploy visualization from CFR run ${{ needs.find-latest-cfr-run.outputs.run_number }} (viz run ${{ github.run_number }})" || echo "No changes to commit"

          # Push
          git push origin gh-pages

